<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TORITO ‚Äî espejo + retrigger + ARIAL</title>
<style>
  :root{--bg:#000;--fg:#f4f4f6}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Arial, Helvetica, sans-serif}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
  .stage{position:relative;width:min(94vw,560px);aspect-ratio:9/16;border-radius:20px;overflow:hidden;background:#000;box-shadow:0 18px 48px rgba(0,0,0,.5)}
  /* C√°mara en modo espejo (selfie) */
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:1;transform:scaleX(-1)}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  /* Overlay de arranque */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9;text-align:center;cursor:pointer}
  .cta{background:#ffffff12;border:1px solid #ffffff2d;color:#fff;padding:14px 18px;border-radius:14px;font-size:16px;backdrop-filter:blur(6px)}
  /* HUD */
  .hud{position:absolute;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;font-size:12px;opacity:.95}
  .pill{border:1px solid #2c2c30;background:#141417;padding:6px 10px;border-radius:999px}
  .log{max-width:560px;width:100%;margin-top:12px;background:#0e0e11;border:1px solid #26262b;border-radius:12px;padding:10px;font-size:12px;line-height:1.35;white-space:pre-wrap}
  .ok{color:#9BEF8A}.warn{color:#FFD166}.err{color:#FF6B6B}
  /* Texto ARIAL MAY√öSCULA, centrado y con presencia */
  #toritoText{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    padding:0 8%; text-align:center; opacity:0; transform:translateY(6px);
    transition:opacity .45s ease, transform .45s ease, filter .2s ease;
    mix-blend-mode:screen; pointer-events:none;
  }
  #toritoText.show{opacity:1; transform:translateY(0); animation:breathe 3.8s ease-in-out infinite}
  #toritoText .line{
    font-family:Arial, Helvetica, sans-serif;
    font-weight:700; letter-spacing:.02em;
    font-size:clamp(26px, 5vw, 48px);
    line-height:1.06; color:#ffffff;
    text-transform:uppercase;
    text-shadow:0 1px 0 rgba(0,0,0,.25), 0 0 16px rgba(255,255,255,.05);
  }
  @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
  /* FX de activaci√≥n (pulso + vi√±eta) */
  .fx{
    position:absolute;inset:0;pointer-events:none;z-index:8;
    opacity:0; transition:opacity .18s ease, filter .18s ease, transform .18s ease;
    background: radial-gradient(ellipse at center, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 38%) ,
                radial-gradient(ellipse at center, rgba(0,0,0,0) 60%, rgba(0,0,0,.35) 100%);
    mix-blend-mode:screen;
  }
  .stage.active .fx{ opacity:.85; filter:brightness(1.08) contrast(1.06) saturate(1.12); animation:pulse 600ms ease-out forwards, jitter 220ms ease-in-out 0s 1; }
  @keyframes pulse{0%{opacity:.0;filter:brightness(1.0) contrast(1.0) saturate(1.0)} 30%{opacity:.95} 100%{opacity:.25}}
  @keyframes jitter{0%,100%{transform:translate(0,0)} 30%{transform:translate(0.6px,-0.6px)} 60%{transform:translate(-0.6px,0.6px)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="viz"></canvas>

    <!-- FX overlay -->
    <div class="fx" id="fx"></div>

    <!-- Overlay de inicio -->
    <div class="overlay" id="ovl"><div class="cta">Toca para activar c√°mara + audio</div></div>

    <!-- HUD -->
    <div class="hud">
      <div class="pill" id="state">estado: idle</div>
      <div class="pill" id="meters">cuernos: ‚Äî</div>
    </div>

    <!-- Texto -->
    <div id="toritoText" aria-hidden="true"><div class="line">SOY UN TORITO BRAVO</div></div>
  </div>
  <div class="log" id="log"></div>
</div>

<!-- MediaPipe Holistic -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script>
/* ===== util de log ===== */
const logEl=document.getElementById('log');
function log(m,c=''){const d=document.createElement('div');d.className=c;d.textContent=m;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}

/* ===== elementos ===== */
const video=document.getElementById('cam');
const canvas=document.getElementById('viz');
const ctx2d=canvas.getContext('2d');
const stage=document.getElementById('stage');
const ovl=document.getElementById('ovl');
const stateEl=document.getElementById('state');
const metersEl=document.getElementById('meters');
const textWrap=document.getElementById('toritoText');

/* ===== audio: torito_vocal con RETRIGGER ===== */
let actx, masterGain, bufferTorito=null, loopGain=null, currentSource=null, audioReady=false;
function ctx(){return actx||(actx=new (window.AudioContext||window.webkitAudioContext)());}
function ensureMaster(){const c=ctx(); if(!masterGain){masterGain=c.createGain();masterGain.gain.value=0;masterGain.connect(c.destination);} return masterGain;}
function ramp(param,to,t=.25){const c=ctx();const n=c.currentTime;param.cancelScheduledValues(n);param.setValueAtTime(param.value,n);param.linearRampToValueAtTime(to,n+t);}
async function loadTorito(){
  for(const ext of ['wav','mp3']){
    try{
      const r=await fetch(`assets/torito_vocal.${ext}`,{cache:'no-store'}); if(!r.ok) continue;
      const a=await r.arrayBuffer(); bufferTorito=await ctx().decodeAudioData(a);
      audioReady=true; log('Audio cargado: torito_vocal.'+ext,'ok'); return;
    }catch(e){ log('Decode fall√≥ ('+ext+'): '+(e.message||e),'warn'); }
  }
  throw new Error('No pude cargar torito_vocal (.wav/.mp3)');
}
function startToritoFromZero(){
  if(!audioReady || !bufferTorito) return;
  stopTorito(); // aseg√∫rate de cortar el anterior
  const c=ctx();
  const src=c.createBufferSource(); src.buffer=bufferTorito; src.loop=true;
  if(!loopGain){ loopGain=c.createGain(); loopGain.gain.value=0; loopGain.connect(ensureMaster()); }
  src.connect(loopGain); src.start(0);
  currentSource=src;
}
function stopTorito(){
  try{ if(currentSource){ currentSource.stop(0); currentSource.disconnect(); } }catch{}
  currentSource=null;
}

/* ===== Holistic (cuernos) ===== */
let holistic, started=false, horns=false, hornFrames=0, noHornFrames=0;
const LM={NOSE:1, CHIN:152, EYE_L_TOP:159, EYE_R_TOP:386, HAND_INDEX_TIP:8, HAND_INDEX_PIP:6};
function isPointingUp(pip,tip){ if(!pip||!tip) return false; const dx=tip.x-pip.x, dy=tip.y-pip.y; return (dy < -Math.abs(dx)*0.6); }
function hornsHeuristic(res){
  const face=res.faceLandmarks, left=res.leftHandLandmarks, right=res.rightHandLandmarks;
  if(!face||!left||!right) return false;
  const nose=face[LM.NOSE], chin=face[LM.CHIN]; const headScale=Math.hypot(nose.x-chin.x,nose.y-chin.y)||1e-3;
  const eyeY=(face[LM.EYE_L_TOP].y+face[LM.EYE_R_TOP].y)/2;
  const li_t=left[LM.HAND_INDEX_TIP], li_p=left[LM.HAND_INDEX_PIP];
  const ri_t=right[LM.HAND_INDEX_TIP], ri_p=right[LM.HAND_INDEX_PIP];
  if(!li_t||!ri_t) return false;
  const leftAbove  = li_t.y < eyeY - 0.02*headScale;
  const rightAbove = ri_t.y < eyeY - 0.02*headScale;
  const leftSide   = li_t.x > nose.x + 0.08*headScale;
  const rightSide  = ri_t.x < nose.x - 0.08*headScale;
  const leftUp=isPointingUp(li_p,li_t), rightUp=isPointingUp(ri_p,ri_t);
  return leftAbove && rightAbove && leftSide && rightSide && leftUp && rightUp;
}
function onResults(res){
  if(hornsHeuristic(res)){ hornFrames++; noHornFrames=0; } else { noHornFrames++; hornFrames=0; }
  const detected = hornFrames>5 ? true : (noHornFrames>6 ? false : horns);
  if(detected !== horns){
    horns=detected;
    stateEl.textContent='estado: '+(horns?'TORITO ON':'idle');
    if(horns){
      // retrigger: reinicia el loop desde 0 y enciende master/texto/fx
      startToritoFromZero();
      ramp(ensureMaster().gain, 0.95, .18);
      if(loopGain) ramp(loopGain.gain, 0.85, .18);
      textWrap.classList.add('show');
      stage.classList.add('active');
    }else{
      // stop: funde y corta
      if(loopGain) ramp(loopGain.gain, 0.0, .22);
      ramp(ensureMaster().gain, 0.0, .22);
      setTimeout(stopTorito, 240);
      textWrap.classList.remove('show');
      stage.classList.remove('active');
    }
  }
  metersEl.textContent='cuernos: '+(horns?'s√≠':'no');
}

/* ===== start ===== */
async function start(){
  if(started) return; started=true;
  try{
    ctx(); ensureMaster(); await actx.resume();
    await loadTorito();
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:720},height:{ideal:1280}},audio:false});
    video.srcObject=stream; await video.play(); ovl.style.display='none'; log('C√°mara OK ‚úÖ','ok');
    holistic=new Holistic({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5/${f}`});
    holistic.setOptions({modelComplexity:1,smoothLandmarks:true,refineFaceLandmarks:true,minDetectionConfidence:.6,minTrackingConfidence:.6});
    holistic.onResults(onResults);
    new Camera(video,{onFrame:async()=>{await holistic.send({image:video});}}).start();
    log('Listo. Gesto de cuernos activa texto y audio (retrigger) üêÇ','ok');
  }catch(e){
    log('Error start: '+(e?.message||e),'err');
    ovl.style.display='flex'; ovl.querySelector('.cta').textContent='Reintentar'; started=false;
  }
}
ovl.addEventListener('click', start);
stage.addEventListener('click', (e)=>{ if(ovl.style.display!=='none') start(); });
</script>
</body>
</html>
